<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Leaflet 3D Cuboid</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
  body { margin:0; padding:0; }
  #map { width:100%; height:100vh; }
  canvas { position:absolute; top:0; left:0; pointer-events:none; z-index:400; }
</style>
</head>
<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="libs/three.js/build/three.min.js"></script>

<script>
// --- Leaflet map ---
const map = L.map('map').setView([28.565,77.105], 14);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution:'Â© OpenStreetMap contributors'
}).addTo(map);

// --- Three.js setup ---
const renderer = new THREE.WebGLRenderer({ alpha:true });
renderer.setSize(map.getSize().x, map.getSize().y);
document.getElementById('map').appendChild(renderer.domElement);

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(60, map.getSize().x/map.getSize().y, 0.1, 10000);
camera.position.set(0, -500, 500); // tilt to see sides
camera.lookAt(0,0,0);

// --- Convert lat/lng to x,y in meters (simple equirectangular) ---
function latLngToMeters(lat, lng, originLat, originLng){
  const R = 6378137; // Earth radius in meters
  const x = (lng - originLng) * Math.PI/180 * R * Math.cos(originLat * Math.PI/180);
  const y = (lat - originLat) * Math.PI/180 * R;
  return [x, y];
}

// --- Cuboid coordinates ---
const coords = [
  [28.56883,77.08464],
  [28.56000,77.12600],
  [28.55500,77.12525],
  [28.56550,77.08200]
];

const originLat = coords[0][0];
const originLng = coords[0][1];

const shape = new THREE.Shape();
coords.forEach((c,i)=>{
  const [x,y] = latLngToMeters(c[0],c[1], originLat, originLng);
  if(i===0) shape.moveTo(x,y);
  else shape.lineTo(x,y);
});

// --- Extrude 5 meters ---
const geometry = new THREE.ExtrudeGeometry(shape, { depth:5, bevelEnabled:false });
const material = new THREE.MeshNormalMaterial({ opacity:0.7, transparent:true });
const cuboid = new THREE.Mesh(geometry, material);
scene.add(cuboid);

// --- Center scene ---
cuboid.position.z = 0;

// --- Update renderer on resize ---
window.addEventListener('resize', ()=>{
  renderer.setSize(map.getSize().x, map.getSize().y);
  camera.aspect = map.getSize().x/map.getSize().y;
  camera.updateProjectionMatrix();
});

// --- Animate loop ---
function animate(){
  requestAnimationFrame(animate);
  renderer.render(scene, camera);
}
animate();

// --- Sync camera with map movement ---
map.on('zoom move', ()=>{
  // Recalculate camera position if needed
  const center = map.getCenter();
  const [cx,cy] = latLngToMeters(center.lat, center.lng, originLat, originLng);
  camera.position.x = cx;
  camera.position.y = cy - 500;
  camera.lookAt(cx,cy,0);
});
</script>
</body>
</html>
