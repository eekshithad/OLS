<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>MapLibre + Three.js Cuboid at Delhi Airport</title>
<link rel="stylesheet" href="https://unpkg.com/maplibre-gl/dist/maplibre-gl.css" />
<style>
  html, body { height: 100%; margin: 0; padding: 0; }
  #map { width: 100%; height: 100%; }
</style>
</head>
<body>
<div id="map"></div>

<!-- MapLibre -->
<script src="https://unpkg.com/maplibre-gl/dist/maplibre-gl.js"></script>

<!-- Three.js ES module -->
<script type="module">
/* IMPORT THREE MODULE */
import * as THREE from "https://unpkg.com/three@0.160.0/build/three.module.js";

/* ----------------------------
      MAP SETTINGS 
-----------------------------*/
const runwayCenter = [77.1035, 28.5562];   // Delhi Airport runway midpoint

const map = new maplibregl.Map({
  container: "map",
  style: "https://demotiles.maplibre.org/style.json",
  center: runwayCenter,
  zoom: 16,
  pitch: 60,
  bearing: -20,
  antialias: true
});

/* ----------------------------
    THREE.js CUSTOM LAYER
-----------------------------*/
map.on("load", () => {

  const merc = maplibregl.MercatorCoordinate.fromLngLat(runwayCenter, 5);

  // meters â†’ Mercator units
  const scale = merc.meterInMercatorCoordinateUnits();

  const customLayer = {
    id: "three-layer",
    type: "custom",
    renderingMode: "3d",

    onAdd: function (map, gl) {
      this.scene = new THREE.Scene();
      this.camera = new THREE.Camera();

      // Lights
      this.scene.add(new THREE.AmbientLight(0xffffff, 0.6));
      const dir = new THREE.DirectionalLight(0xffffff, 1);
      dir.position.set(0, 100, 50);
      this.scene.add(dir);

      /* ----------------------
          CUBOID (in meters)
      -----------------------*/
      const width = 60;
      const height = 30;
      const depth = 20;

      const geom = new THREE.BoxGeometry(width, height, depth);
      const mat = new THREE.MeshStandardMaterial({ color: 0xff5733 });

      this.mesh = new THREE.Mesh(geom, mat);

      // Bottom touching ground
      this.mesh.position.set(0, height / 2, 0);

      this.scene.add(this.mesh);

      /* ----------------------
          WEBGL RENDERER
      -----------------------*/
      this.renderer = new THREE.WebGLRenderer({
        canvas: map.getCanvas(),
        context: gl,
        antialias: true
      });
      this.renderer.autoClear = false;

      /* ----------------------
          MODEL TRANSFORM
      -----------------------*/
      this.modelMatrix = new THREE.Matrix4()
        .makeTranslation(merc.x, merc.y, merc.z)
        .multiply(new THREE.Matrix4().makeScale(scale, scale, scale));
    },

    render: function (gl, matrix) {
      const m = new THREE.Matrix4().fromArray(matrix);
      this.camera.projectionMatrix = m.multiply(this.modelMatrix);

      this.renderer.state.reset();
      this.renderer.render(this.scene, this.camera);

      map.triggerRepaint();
    }
  };

  map.addLayer(customLayer);

});
</script>

</body>
</html>
